<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Manipulação de bases no R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Professor: Vitor Pereira" />
    <script src="Aula_R_files/header-attrs-2.16/header-attrs.js"></script>
    <link href="Aula_R_files/tabwid-1.0.0/tabwid.css" rel="stylesheet" />
    <link href="Aula_R_files/tabwid-1.0.0/scrool.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Manipulação de bases no R
]
.author[
### Professor: Vitor Pereira
]
.date[
### 14/09/2022
]

---





## Preâmbulo

- Apagando tudo no ambiente


```r
rm(list=ls()) # apaga tudo no ambiente
```

- Instalar os pacotes de que precisarás
  - Pacotes padrão (CRAN) podem ser instalados com:


```r
install.packages("devtools")
```

  - Outros pacotes armazenados no github precisam do Devtools::

```r
devtools:: install_github("data-edu/dataedu")
```

- Depois precisamos carregar os pacotes
  - Notem que não precisamos das aspas

```r
library(devtools)
```

---
## Preâmbulo

- O pacote "pacman" já inspeciona quais pacotes tens instalados, instala o que não tiver sido instalado e já carrega os pacotes


```r
pacman:: p_load(tidyverse, apaTables, sjPlot,
                readxl, dataedu, zelador, epiDisplay)
```

Para São Tomé e Príncipe, é importante acertar a hora do R:

```r
Sys.setenv(TZ="UCT") # Acerta a hora de STP
```

---

# Preâmbulo: Os caminhos

- Os caminhos servem para organizar o trabalho
  - São cruciais para trabalhar colaborativamente!
  - Para alterar de um computador para o outro, basta modificar a linha "root"
  

```r
# Paths
root     &lt;- "C:/Users/vitor/Dropbox (Personal)/Sao Tome e Principe/2022/Boletim_estatisco/"
input    &lt;- paste0(root, "input/")
output   &lt;- paste0(root, "output/")
tmp      &lt;- paste0(root, "tmp/")
code     &lt;- paste0(root, "code/")
alunos   &lt;- paste0(root, "alunos/")
setwd(root)
```


```r
pacman:: p_load(magrittr, dplyr, vctrs, readr, ggplot2, sf,
                janitor, readxl, gt, epiDisplay, gapminder,
                data.table, formattable, tidyr, crosstable)

# Paths
root     &lt;-  "C:/Users/Utilizador/Desktop/R_STP/"
input    &lt;- paste0(root, "input/")
output   &lt;- paste0(root, "output/")
tmp      &lt;- paste0(root, "tmp/")
code     &lt;- paste0(root, "code/")
alunos   &lt;- paste0(root, "alunos/")

# Le todas as colunas e decide quais sao numericas
col_types &lt;- readr::cols(.default = readr::col_character())

# Acerta a hora de STP
Sys.setenv(TZ="UCT")
#######################################

basica            &lt;- clean_names(as.data.frame(read_excel(paste0(input, "BASE BÁSICO - inicio ano 2021-2022.xlsx"), sheet = "Base Aluno")))
secundaria_7_9    &lt;- clean_names(as.data.frame(read_excel(paste0(input,"Base Dados inicio Secundario -18-07-2022.xlsx"), sheet="Alunos 7ª- 9ª classes")))
secundaria_10_12  &lt;- clean_names(as.data.frame(read_excel(paste0(input,"Base Dados inicio Secundario -18-07-2022.xlsx"), sheet="Alunos 10ª- 12ª Classes")))

basica &lt;- basica %&gt;% # o pipe indica que estamos a ultizar a base chamada basica
  remove_empty(c("rows", "cols")) %&gt;% #retiramos as linhas e colunas vazias
  dplyr::select(-codigo_escola) %&gt;%  # ficamos com todas as colunas, excepto o codigo_escola
  mutate(across(.fns = as.character)) # transformamos todas as colunas em texto

secundaria_7_9 &lt;- secundaria_7_9 %&gt;% 
  remove_empty(c("rows", "cols")) %&gt;% 
  dplyr:: select(-codigo_escola)  %&gt;% 
  mutate(across(.fns = as.character))

secundaria_10_12 &lt;- secundaria_10_12%&gt;% 
  remove_empty(c("rows", "cols"))  %&gt;% 
  dplyr::select(-codigo_escola)  %&gt;% 
  mutate(across(.fns = as.character))

# Teste se as colunas sao iguais
# all.equal(secundaria_7_9_v2,secundaria_10_12_v2,
#          ignore_col_order=TRUE )

# Append- agregacao das bases, uma base em cima da outra
base_alunos &lt;- bind_rows(basica, secundaria_7_9, # append das bases
                         secundaria_10_12) %&gt;%
  mutate(distrito=replace(distrito, # corrige o distrito
                          distrito=="LOBATA","Lobata"), 
         classe = gsub("ª", "", classe)) # Tira o "ª" 

#transforma de volta as colunas numericas para o formato de numero  
base_alunos &lt;- readr::type_convert(base_alunos) 

tab1(base_alunos$distrito)
```

```r
tab1(base_alunos$idade)
```

```r
tab1(base_alunos$classe)
```

```r
base_alunos &lt;- base_alunos %&gt;% 
  mutate(distorcao = case_when(
    idade-classe-5 &gt;=2 ~ "Em distorção",
    idade-classe-5 &lt; 2 ~ "Fora de distorção" )) 

# Vamos retirar as bases que não vamos mais usar
rm(list = c("basica", "col_types",
            "secundaria_7_9", 
            "secundaria_10_12"))

tab1(base_alunos$distorcao)
```

```r
base_alunos &lt;- base_alunos %&gt;% 
  mutate(classe_f=factor(classe))
```


- Atenção: 
  - As barras são para a direita!
  - As vezes o cominho fica muito longo e o R não consegue ler. Nesse caso, é melhor salvar a pasta do projeto em C:\

---

# Preâmbulo: Último passo...

- Se precisarmos em algum momento passar toda a base para caractere ( para poder fazer o append/rbind/apensar bases na vertical)



```r
# Le todas as colunas e decide quais sao numericas
col_types &lt;- readr::cols(.default = readr::col_character())
```

- Essa linha será aproveitada depois quando for converter de volta as colunas com números para fomato numérico. Não se esqueça de carregar o pacote readr


```r
#transforma de volta as colunas numericas para o formato de numero  
base_alunos &lt;- readr::type_convert(base_alunos) 
```


- Por último, separe visualmente cada parte do código


```r
#######################################
```

- Atenção: Comentem abundantemente seus códigos com o cardinal

---

# Como abrir a base

- A forma de abrir a base dependerá do formato da base

- Arquivos em csv podem ser abertos através do pacote readr()


```r
pacman:: p_load(readr)
iris &lt;- read_csv("iris.csv")
```

- Arquivos de excel em xlsx podem ser abertos atravé do pacote readxl. Observe que precisamos nomear o ficheiro e a folha.


```r
pacman::p_load(readxl)
basica&lt;-read_excel(paste0(input, "BASE BÁSICO - inicio ano 2021-2022.xlsx"), sheet = "Base Aluno")
```

---
# Como abrir a base

- Arquivos em stata precisam do pacote readstata13


```r
pacman::p_load(readstata13)
dat &lt;- read.dta13("TEAdataSTATA.dta")
```

- Arquivos em SPSS dependem do pacote 


```r
pacman::p_load(haven)
dataset = read_sav(path)
```

- Arquivos em txt

```r
df &lt;- read.table("dataset.txt", header=TRUE, sep=",")
```

---

# Visualizando a base

- Os comandos View(), head(), str(), tab1()  e summary() servem para inspecionar a base de dados


```r
# vamos abrir o pacote
library(readr)
library(epiDisplay)
iris &lt;- read_csv("iris.csv")
head(iris) #primeiras linhas
str(iris) # estrutura da base
View(iris) # abre a base para poder olhar
summary(iris) # faz um resumo da base
tab1(iris$sepal.length)
```

_ O str mostra a estrutura da base
- Não confundam summary com summarise. O summary() vai dar um resumo de cada variável
- O tab1 depende do pacote epiDisplay

---
# Como limpar as bases

- Os nomes das colunas das bases não podem ter espaços, nem traços, nem caracteres especiais
- Para limpar esses nomes, basta utilizar o comando clean_names() do pacote janitor()


```r
# Limpando os nomes das variáveis
pacman::p_load(janitor)
pre_survey &lt;- clean_names(dataedu::pre_survey)
```

---
# Como limpar as bases

- Os nomes de algumas colunas podem vir muito grandes ou ser pouco informativos. Para modificar, utilizamos o comando rename()


```r
# renomear variaveis
pre_survey &lt;- pre_survey %&gt;%
  rename(
    q1 = q1maincellgroup_row1 , 
    q2 = q1maincellgroup_row2 , 
    q3 = q1maincellgroup_row3 , 
    q4 = q1maincellgroup_row4 , 
    q5 = q1maincellgroup_row5 , 
    q6 = q1maincellgroup_row6 , 
    q7 = q1maincellgroup_row7 , 
    q8 = q1maincellgroup_row8 , 
    q9 = q1maincellgroup_row9 , 
    q10 = q1maincellgroup_row10, 
    usuario = opdata_username, 
    curso = opdata_course_id
    ) 
```
---

# Remover colunas e linhas vazias

- Para remover as colunas e linhas vazias, utilze o comando remove_empty(), do pacote janitor


```r
# Remove as linhas e colunas vazias
 remove_empty(c("rows", "cols"))
```

---

# Limpar o conteúdo das variáveis

- É possível retirar caracteres especiais
  - Dentro de uma pipe(%&gt;%), coloque:
  

```r
   classe = gsub("ª", "", classe)) # Tira o "ª" 
```

- Nesse exemplo, retiramos todos símbolos "ª" da variável classe, permitindo convert-la para números 

---

# Limpar o conteúdo das variáveis

- Também é possível modificar o conteúdo de uma variável. 

- Para isso, vamos utilizar os comandos mutate() e replace() do pacote dplyr()


```r
pacman::p_load(dplyr)
# Append- agregacao das bases, uma base em cima da outra
base_alunos &lt;- base_alunos %&gt;% 
  mutate(distrito=replace(distrito, # corrige o distrito
                          distrito=="LOBATA","Lobata"))
```

---

# Limpar o conteúdo das variáveis

- Também é possível utilizar o comando case_when () do mutate() e dplyr() 

- Também podemos utilizar o mutate(case_when()) para criar novas variáveis. Exemplo:


```r
base_alunos &lt;- base_alunos %&gt;% 
  mutate(distorcao = case_when(
    idade-classe-5 &gt;=2 ~ "Em distorção",
    idade-classe-5 &lt; 2 ~ "Fora de distorção" )) 
```


---

# Substituindo o texto de uma variável

- Para substituir o texto dentro de uma variável, utilizamos o comando **gsub**. 


```r
base_alunos &lt;- base_alunos %&gt;% 
mutate(classe = gsub("ª", "", classe)) # Tira o "ª" 
```
- Notem que a variável era de texto, e quando tiramos o "ª", ela continua de texto. Se quiséssemos transfor-la em numérica, aplicar+iamos o comando **as.numeric**


```r
base_nova &lt;- secundaria_7_9 %&gt;% 
  mutate(classe = gsub("ª", "", classe))%&gt;% # Tira o "ª" 
  mutate(classe= as.numeric(classe)) # transforma em número
```
_ Para fazer o contrário (de numérico para texto), usamos o comando **as.character**


---

# O tipo de variável "fator" (factor)

Um tipo de variável cum e bastante utilizado em análises econométricas e para formaçºao de tabelas é o factor

 O r interpreta o factor como uma  variável de "camadas". 
 
Observe a diferença do comando cross table quando utilizamos uma variável numérica e quando a transformamos em factor


```r
crosstable(base_alunos, c(classe_f), by=c(distorcao), total="both", 
           percent_pattern="{n} ({p_row})", percent_digits=0) %&gt;%
  as_flextable()
```


---

# Sem o factor


&lt;template id="95260306-765b-409f-b066-796156e4604d"&gt;&lt;style&gt;
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
.katex-display {
    margin: 0 0 !important;
}
&lt;/style&gt;&lt;div class="tabwid"&gt;&lt;style&gt;.cl-c922c5c6{}.cl-c91b53ea{font-family:'Arial';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c91b53f4{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c91b6736{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c91b6740{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c91b98a0{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98a1{width:51.7pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98aa{width:78.6pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98ab{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98b4{width:73.1pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98b5{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98b6{width:78.6pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98be{width:73.1pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98bf{width:51.7pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98c0{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98c8{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98c9{width:78.6pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98ca{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98d2{width:51.7pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98d3{width:73.1pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98d4{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98d5{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98dc{width:51.7pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98dd{width:78.6pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98de{width:73.1pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98df{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98e6{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98e7{width:73.1pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98e8{width:51.7pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98f0{width:78.6pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98f1{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98fa{width:51.7pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98fb{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98fc{width:78.6pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c91b98fd{width:73.1pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}&lt;/style&gt;&lt;table class='cl-c922c5c6'&gt;&lt;thead&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td  rowspan="2"class="cl-c91b98e8"&gt;&lt;p class="cl-c91b6736"&gt;&lt;span class="cl-c91b53ea"&gt;label&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td  rowspan="2"class="cl-c91b98e7"&gt;&lt;p class="cl-c91b6736"&gt;&lt;span class="cl-c91b53ea"&gt;variable&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td  colspan="2"class="cl-c91b98e6"&gt;&lt;p class="cl-c91b6736"&gt;&lt;span class="cl-c91b53ea"&gt;distorcao&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td  rowspan="2"class="cl-c91b98f0"&gt;&lt;p class="cl-c91b6736"&gt;&lt;span class="cl-c91b53ea"&gt;Total&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c91b98f1"&gt;&lt;p class="cl-c91b6736"&gt;&lt;span class="cl-c91b53ea"&gt;Em distorção&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98fb"&gt;&lt;p class="cl-c91b6736"&gt;&lt;span class="cl-c91b53ea"&gt;Fora de distorção&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td  rowspan="4"class="cl-c91b98a1"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;classe&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98b4"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;Min / Max&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98a0"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;1.0 / 12.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98ab"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;1.0 / 12.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98aa"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;1.0 / 12.0&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c91b98be"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;Med [IQR]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98c0"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;8.0 [6.0;10.0]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98b5"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;5.0 [3.0;8.0]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98b6"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;6.0 [3.0;8.0]&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c91b98d3"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;Mean (std)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98c8"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;8.1 (2.5)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98ca"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;5.4 (3.1)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98c9"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;6.0 (3.2)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c91b98de"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;N (NA)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98d4"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;14706 (0)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98d5"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;50580 (0)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c91b98dd"&gt;&lt;p class="cl-c91b6740"&gt;&lt;span class="cl-c91b53f4"&gt;65286 (0)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/template&gt;
&lt;div class="flextable-shadow-host" id="9a691e1d-9cde-4956-940b-1ca914f7d142"&gt;&lt;/div&gt;
&lt;script&gt;
var dest = document.getElementById("9a691e1d-9cde-4956-940b-1ca914f7d142");
var template = document.getElementById("95260306-765b-409f-b066-796156e4604d");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
&lt;/script&gt;
 
---

# Com o factor


&lt;template id="15df36b6-af14-47b6-a5b8-df24b6c15c4c"&gt;&lt;style&gt;
.tabwid table{
  border-spacing:0px !important;
  border-collapse:collapse;
  line-height:1;
  margin-left:auto;
  margin-right:auto;
  border-width: 0;
  display: table;
  margin-top: 1.275em;
  margin-bottom: 1.275em;
  border-color: transparent;
}
.tabwid_left table{
  margin-left:0;
}
.tabwid_right table{
  margin-right:0;
}
.tabwid td {
    padding: 0;
}
.tabwid a {
  text-decoration: none;
}
.tabwid thead {
    background-color: transparent;
}
.tabwid tfoot {
    background-color: transparent;
}
.tabwid table tr {
background-color: transparent;
}
.katex-display {
    margin: 0 0 !important;
}
&lt;/style&gt;&lt;div class="tabwid"&gt;&lt;style&gt;.cl-c964cb60{}.cl-c95dcd6a{font-family:'Arial';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c95dcd74{font-family:'Arial';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-c95ddd32{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c95ddd33{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-c95e1176{width:60.9pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e1180{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e1181{width:89.6pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e1182{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e118a{width:62.1pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e118b{width:60.9pt;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e1194{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e1195{width:62.1pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e1196{width:89.6pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e119e{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 2pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e119f{width:62.1pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11a0{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11a8{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 1pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11a9{width:60.9pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11aa{width:89.6pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1.5pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11b2{width:60.9pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11b3{width:62.1pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11b4{width:90.2pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11bc{width:112.8pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-c95e11bd{width:89.6pt;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(0, 0, 0, 1.00);border-top: 1pt solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(255, 255, 255, 0.00);border-right: 0 solid rgba(255, 255, 255, 0.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}&lt;/style&gt;&lt;table class='cl-c964cb60'&gt;&lt;thead&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td  rowspan="2"class="cl-c95e11a9"&gt;&lt;p class="cl-c95ddd32"&gt;&lt;span class="cl-c95dcd6a"&gt;label&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td  rowspan="2"class="cl-c95e119f"&gt;&lt;p class="cl-c95ddd32"&gt;&lt;span class="cl-c95dcd6a"&gt;variable&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td  colspan="2"class="cl-c95e11a0"&gt;&lt;p class="cl-c95ddd32"&gt;&lt;span class="cl-c95dcd6a"&gt;distorcao&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td  rowspan="2"class="cl-c95e11aa"&gt;&lt;p class="cl-c95ddd32"&gt;&lt;span class="cl-c95dcd6a"&gt;Total&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e11b4"&gt;&lt;p class="cl-c95ddd32"&gt;&lt;span class="cl-c95dcd6a"&gt;Em distorção&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e11bc"&gt;&lt;p class="cl-c95ddd32"&gt;&lt;span class="cl-c95dcd6a"&gt;Fora de distorção&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td  rowspan="13"class="cl-c95e1176"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;classe_f&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;91 (2%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;5195 (98%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;5286 (8%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;2&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;191 (3%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6263 (97%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6454 (10%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;3&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;162 (3%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;4615 (97%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;4777 (7%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;812 (11%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6525 (89%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;7337 (11%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;5&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1055 (17%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;5106 (83%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6161 (9%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1544 (24%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;4843 (76%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6387 (10%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;7&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;2005 (31%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;4434 (69%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6439 (10%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;8&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;2238 (35%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;4157 (65%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;6395 (10%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;9&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;2310 (41%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;3317 (59%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;5627 (9%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;10&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1255 (36%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;2203 (64%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;3458 (5%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;11&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1635 (42%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;2266 (58%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;3901 (6%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e118a"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;12&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1182"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1408 (46%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1180"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;1656 (54%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1181"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;3064 (5%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr style="overflow-wrap:break-word;"&gt;&lt;td class="cl-c95e1195"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;Total&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e119e"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;14706 (23%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1194"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;50580 (77%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td class="cl-c95e1196"&gt;&lt;p class="cl-c95ddd33"&gt;&lt;span class="cl-c95dcd74"&gt;65286 (100%)&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/template&gt;
&lt;div class="flextable-shadow-host" id="5335adfb-59d7-4f04-9df9-bd64d4fab9ff"&gt;&lt;/div&gt;
&lt;script&gt;
var dest = document.getElementById("5335adfb-59d7-4f04-9df9-bd64d4fab9ff");
var template = document.getElementById("15df36b6-af14-47b6-a5b8-df24b6c15c4c");
var caption = template.content.querySelector("caption");
if(caption) {
  caption.style.cssText = "display:block;text-align:center;";
  var newcapt = document.createElement("p");
  newcapt.appendChild(caption)
  dest.parentNode.insertBefore(newcapt, dest.previousSibling);
}
var fantome = dest.attachShadow({mode: 'open'});
var templateContent = template.content;
fantome.appendChild(templateContent);
&lt;/script&gt;

---

# Manipulando os dados: O dplyr

- O pacote dplyr possui alguns comandos bastante importantes:

select() - seleciona colunas
arrange() - ordena a base
filter() - filtra linhas
mutate() - cria/modifica colunas
group_by() - agrupa a base
summarise() - sumariza a base


---

# Exemplos- dplyr: O mutate


```r
- Mutate para criar uma nova variável categórica

measure_mean &lt;- measure_mean %&gt;% 
  mutate( construto = case_when(
      questao %in% c("q1", "q4", "q5", "q8", "q10") ~ "interesse" ,
      questao %in% c("q2", "q6" , "q9") ~ "utilidade do curso", 
      questao %in% c("q3", "q7") ~ "competencia percebida"))
```

---

# O mutate(case_when)


- O case_when nos permite criar uma variável nome, modificando uma outra variável. 

- Podemos criar categorias, intervalos, etc....

- Note a sintaxe: Primeiro vem o valor antigo, e o valor que queremos criar vem depois **~**


- Exemplo:


```r
ciclo &lt;- base_alunos %&gt;% 
  mutate(case_when(
    classe == 1 ~ "1o ciclo", 
    classe == 2 ~ "1o ciclo", 
    classe == 3 ~ "2o ciclo", 
    classe == 4 ~ "2o ciclo"  ))
```

---

# O mutate(case_when)

- Outro exemplo: Criamos um código para cada distrito



```r
        mutate(ADM2_PCODE=
           case_when(distrito == "R.A.Príncipe" ~ "ST0101" , 
                     distrito == "Água Grande"  ~ "ST0201" ,
                     distrito == "Cantagalo"    ~ "ST0202" ,
                     distrito == "Caué"         ~ "ST0203" ,
                     distrito == "Lembá"        ~ "ST0204" ,
                     distrito == "Lobata"       ~ "ST0205" ,
                     distrito == "Mé-Zochi"     ~ "ST0206")) 
```

---

# O mutate(case_when)

- Outro exemplo: Aqui, a variável country deve ser vazia ("") para todos os países, exceto São Tomé e Príncipe


```r
base_stp &lt;-base_gapminder %&gt;% 
  mutate(pais_STP=case_when(
    country == "Sao Tome and Principe" ~ "STP", 
    country != "Sao Tome and Principe" ~ "" ))
```

Note que poderíamos ter alcançado o mesmo resultado com **TRUE~""**


```r
base_stp2 &lt;-base_paises %&gt;% 
  mutate(pais_STP2=case_when(
    country == "Sao Tome and Principe" ~ "STP", 
    TRUE ~""))
```

---

# Outro exemplo de mutate, com **%in%**

- Nesse caso, se a variável questão possui alguns dos valores "q1", "q4", "q5", "q8", "q10", então retorna "interesse", e por aí vai



```r
measure_mean &lt;- measure_mean %&gt;% 
  mutate( construto = case_when(
      questao %in% c("q1", "q4", "q5", "q8", "q10") ~ "interesse" ,
      questao %in% c("q2", "q6" , "q9") ~ "utilidade do curso", 
      questao %in% c("q3", "q7") ~ "competencia percebida"))
```

- Note que economizamos muitas linhas com essa notação

---

# Exemplos- dplyr: O select

- O comando select irá selecionar as colunas desejas

```r
basica &lt;- basica %&gt;% 
  dplyr::select(codigo_escola) %&gt;%  # Ficamos apenas com o códiugo da escola
```

- Se você quiser todas as colunas, exceto algumas, basta colocar o símbolo de menos (-) antes da variável que desejas excluir. 


```r
basica &lt;- basica %&gt;% 
  dplyr::select(-codigo_escola) %&gt;%  # ficamos com todas as colunas, excepto o codigo_escola
```

---

# Exemplos- dplyr: O filter()

- O filter seleciona as linhas. 

- **Não confundir com o select, que seleciona colunas!**


```r
base_alunos2&lt;- base_alunos %&gt;% 
  filter(distrito=="Água Grande")  # ficamos apenas com as observaçºoes referentes a Água Grande
```


---
--- 

# Exemplos- dplyr: O arrange()

- O arrange organiza a base na ordem das variáveis que quiseres


```r
dat5 &lt;- course_data2 %&gt;% 
  arrange(usuario, curso, gradebook_item)
```

- Nesse exemplo, o R irá ordenar a base por ordem de usuário. 
  - Se houver duas ou mais linhas com o mesmo usuário, o R irá ordená-las pela ordem do curso.     
    - Se houver duas ou mais linhas com o mesmo usuário e curso, o R irá ordenar as linhas pela variável "gradebook_item"      
  


---

# O group_by e o summarise


- O comando group_by() irá agrupar "virtualmente" a base de dados de acordo com os valores de uma coluna. Em geral, é utilizado logo antes de uma operação em que a base será reduzida/colapsada através do summarise


```r
medias_construto &lt;- measure_mean %&gt;% 
  group_by(construto) %&gt;% 
  summarise( 
    # Média
    media_respostas = mean(resposta, na.rm=TRUE),
    # Mediana
    median_repostas = median(resposta, na.rm=TRUE), 
    # Desvio Padrao
    desv_pad_repostas = sd(resposta, na.rm=TRUE),
    # Percentual de missings
    perc_missing    = mean(is.na(resposta), 
    # Total de linhas
    total_respostas = n() ,
    # Número de valores distintos de escolas
    total_escolas= n_distinct(school) )
```

---

# O group_by e o summarise

- Observe o exemplo abaixo. 
- O que faz o comando **na.rm=TRUE** ?


```r
# Vamos fazer as medias por construto
medias_construto &lt;- measure_mean %&gt;% 
  group_by(construto) %&gt;%  # agrupa por construto
  summarise( media_respostas = mean(resposta, na.rm=TRUE), # media
             median_repostas = median(resposta, na.rm=TRUE), # mediana
             desv_pad_repostas = sd(resposta, na.rm=TRUE), # desvio padrao
            n_ordem = row_number()), # nuero da linha 
            perc_missing    = mean(is.na(resposta)) # percentual de missings
             
             )
```

- A última linha calcula o percentual de missings. Repare que **is.na** seleciona apenas as linhas com **missings*

---
 
# Distinct

- O comando distinct nos permite tirar os valores repetidos, seja uma linha inteira repetida, ou valores repetidos de uma variável

- **distinct**, portanto, pega apenas valores distintos


```r
distinct(pre_survey4, usuario, curso)
```


---
--- 
 
  ## Transformando todas as colunas em texto
 
 - As vezes , para fazer uma junção na vertical, precisamos passar todas as colunas para texto.
 
  - Por que? Porque o formato de cada coluna deve ser o mesmo. Se uma delas é diferente, teremos um erro. 


```r
# transforma tudo em texto
base_alunos %&gt;%  base alunos %&gt;% 
  mutate(across(.fns = as.character)) # transformamos todas as colunas em texto
```

- Depois de feito o append/rbind, é importante voltar com as colunas numéricas


```r
base_alunos &lt;- bind_rows(basica, secundaria_7_9, 
      secundaria_10_12) %&gt;% # append das bases
# Converte de volta
  base_alunos &lt;- readr::type_convert(base_alunos)
```

---

# Salvando e abrindo bases no formato R

-Para salvar a base no formato R, utilzamos o comando **saveRDS**


```r
#save.image(file = paste0(tmp,"alunos_todos.RData"))
saveRDS(base_alunos, file = paste0(tmp,"alunos_todos_v2.RData"))
```

-Para abrir a base, utilizamos o **readRDS**


```r
# Abre a base dos alunos
base_alunos&lt;- readRDS(paste0(tmp,"alunos_todos_v2.RData"))
```

---

# Unindo bases (vertical)

- Para fazer a união das base na vertical, utilizamos o **bind_rows**
- Faz a união coluna a coluna


&lt;img src="bind_rows.png" width="200"&gt;

- No stata, essa operação é chamada de "append"

---

# Unindo bases (vertical)


```r
# Append- agregacao das bases, uma base em cima da outra
base_alunos &lt;- bind_rows(basica, 
                         secundaria_7_9,
                         secundaria_10_12)
# append das bases
```

---
--- 
# Unindo bases (horizontal)

- Para fazer a união linha a linha, na horizontal, utilizamos o comando **join**, com suas variações

&lt;img src="joins.png" width="400"&gt;

---

# Unindo bases (horizontal)

- A união mais comum e mais útil é o left join.  Ele preserva as linhas que estão na base da esquerda e elimina as linhas que apenas aparecem na base da direita


```r
# Left join
dat &lt;- pre_survey4 %&gt;% 
  left_join(course_data2, by = c("usuario", "curso"))  %&gt;% 
  arrange(usuario, curso, gradebook_item)
```

- O inner join preserva apenas as linhas idênticas

```r
# Inner join
dat2 &lt;- pre_survey4 %&gt;% 
  inner_join(course_data2, by = c("usuario", "curso"))  %&gt;% 
  arrange(usuario, curso, gradebook_item)
```

---
# Unindo bases (horizontal)

- O full join preserva todas as linhas das duas bases


```r
# Full join
dat3 &lt;- pre_survey4 %&gt;% 
  full_join(course_data2, by = c("usuario", "curso"))  %&gt;% 
  arrange(usuario, curso, gradebook_item)
```

- O anti join preserva apenas as linhas que **NÃO** fizeram par


```r
# anti_join
dat6 &lt;- pre_survey4 %&gt;% 
  anti_join(course_data2, by = c("usuario", "curso"))  %&gt;% 
  arrange(usuario, curso )
```

---
# Pivotando a base (tidyr)

- Muitas vezes, precisamos colocar colunas em linhas e linhas em colunas

- Podemos trocar entre os formatos wide e long

&lt;img src="pivot.png" width="300"&gt;


--- Pivot longer 

- O **pivot_longer** transforma uma base em long (a original era wide)

Exemplo:

```r
measure_mean &lt;- pre_survey2 %&gt;% 
  pivot_longer(cols = q1:q10, 
               names_to = "questao", 
               values_to = "resposta")
```

- Nesse exemplo, temos várias colunas contendo q1, q2, q3, etc...
- O nome das colunas será armazenado na coluna "questao"
- O valor das colunas será armazenado na coluna "resposta"

--- Pivot wider 

- O pivot wider transforma uma base em wide (a original era long). 

- O pivot_wider é um pouco mais complicado, pois pode aninhar linhas, inserindo vetores dentro de célular

- Precisamos dizer quis colunas identificam as linhas e, ao final do código, utilizar o comando **unnest()**


```r
base_original &lt;- measure_mean %&gt;% 
  pivot_wider(id_cols= c("usuario","curso"), 
              names_from="questao", 
              values_from="resposta")%&gt;% 
  unnest()
```

---

# Fazendo gráficos com o GGPLOT2

- Primeiro, carregue o pacote ggplot2 com o pacman


```r
pacman:: p_load(ggplot2)
```

- Para fazer o gráfico, é importante que a base esteja preparada para ser representada em forma de gráfico


```r
base_graf1 &lt;- base_alunos %&gt;% 
  mutate(idade_ideal=classe+5) %&gt;% 
  mutate(desvio_idade= idade-idade_ideal) %&gt;% 
  group_by(classe, distrito) %&gt;% 
  summarise(media_desvio_idade=mean(desvio_idade)) 
```

---
# Graficos

- Para fazer o gráfico, usamos a funçºao ggplot, e inseremos a estatica no aes(). 

- Observe aqui, que estamos a dizer o que deve ficar no eixo x, no eixo y, e as cores do grafico.

- Por último, damos a geometria (geom), que diz o tipo de grafico


```r
grafico1&lt;- base_graf1 %&gt;% 
  ggplot(aes(
    x=classe, 
    y=media_desvio_idade, 
    color=distrito)) +
  geom_line()+
  geom_point() +
 labs(title="Desvio da idade ideal por classe")+
 xlab("classe")
```


---

# Graficos

![](Aula_R_files/figure-html/unnamed-chunk-56-1.png)&lt;!-- --&gt;


---

# Explicando: Como fizemos o gráfico?

- 1 - A base precisa estar formatada para o gráfico

- 2 - Recebemos a base, e depois da **pipe (%&gt;%)**, abrimos a sintaxe do ggplot.

  - Nesse momento, precisamos dar a est+etica do gráfico (**aes**). A estética nos diz qual é o eixo x, o eixo y, as cores, etc...) 
    

```r
grafico1&lt;- base_graf1 %&gt;% 
  ggplot(aes(
    x=classe, 
    y=media_desvio_idade, 
    color=distrito))
```


---

# Como fizemos o gráfico? A geometria

- Depois precismos dizer o tipo (geometria) do gráfico. Isso é feito, nesse caso, através do **geom_line()**.

- Podemos sobrepor diferentes geometrias. Por exemplo, podemos colocar pontos: **geom_point**

- Para ir adicionando camadas, utilizamos o símbolo da soma **+**



```r
grafico1&lt;- base_graf1 %&gt;% 
  ggplot(aes(
    x=classe, 
    y=media_desvio_idade, 
    color=distrito)) +
  geom_line()+
  geom_point() 
```

---

# Como fizemos o gráfico? Detalhes

- Por último, adicionamos os últimos detalhes, como:

  - Título
  - Nome do eixo X e do eixo Y
  - A escala do eixo X e os pontos de quebra (break points) do eixo x 


```r
grafico1&lt;- base_graf1 %&gt;% 
  ggplot(aes(
    x=classe, 
    y=media_desvio_idade, 
    color=distrito)) +
  geom_line()+
  geom_point() +
 labs(title="Desvio da idade ideal por classe")+
 xlab("classe") + ylab("Desvio da idade em relaçºao à idade correta para a classe") +
  scale_x_continuous(breaks = seq(1,12, 1))
```

---

# Tipos de geometria

- Linha: **geom_line**
- Ponto: **geom_point**
- Barra: **geom_bar**
- Boxpot: **geom_boxplot**
- Histograma: **geom_histogram**
- Violino: **geom_violin** 
- Estima relação entre variáveis: **geom_smooth**
- Montanhas empilhadas: **geom_density_ridges**  (precisa instalar o pacote **ggridges**)

- O copito doo ggplot2 contém dicas das geometrias mais comuns
  - [Clique aqui para baixar o copito do ggplot2 !](https://raw.githubusercontent.com/rstudio/cheatsheets/main/translations/portuguese/data-visualization_pt.pdf)



---

# Pirâmide etária nas escolas de STP

- Primeiro vamos organizar a base


```r
# Abre a base dos alunos
base_piramide &lt;- base_alunos %&gt;% 
  group_by(sexo, idade) %&gt;% 
  summarise(contagem_alunos = n()) %&gt;% 
  mutate(contagem_alunos= 
           replace(contagem_alunos, 
                   sexo=="F", (-1)* contagem_alunos)) %&gt;% 
  arrange(idade, sexo)
```

- Observe o replace.... Invertemos a contagem do número de meninas multiplcando por -1. Assim, as barras das meninas ficarão para a esquerda, e a dos meninos para a direita.

---

# Pirâmide etária nas escolas de STP

- Agora ao grafico


```r
grafico_piramide &lt;- ggplot(base_piramide, 
                    aes(x= idade, 
                     y= contagem_alunos, 
                     fill= sexo)) +
  geom_bar(data=subset(base_piramide, sexo=="M"),
           stat="identity")+
  geom_bar(data=subset(base_piramide, sexo=="F"),
           stat="identity") +
  scale_y_continuous(breaks = seq(-3000, 3000, 1000), 
                   labels = abs(seq(-3000, 3000, 1000)), 
                   "Quantidade de alunos") +
  coord_flip() +
  scale_fill_brewer(palette="Set2") +
  theme_bw()

grafico_piramide 
```

---

# Pirâmide etária nas escolas de STP


![](Aula_R_files/figure-html/unnamed-chunk-62-1.png)&lt;!-- --&gt;

---
# Explicando o código

- Em geom_bar, aplicamos a barra somente aos meninos. Para isso , utilizamos o comando  **data=subset()**

- Fizemos o mesmo para as meninas

- O **stat="identity"** é padrão para gráficos de barra

- Em **scale_y_continuous**, inserimos os breakpoints, os labels e o título do eixo y

- Depois invertemos os eixos! Note que o título do eixo y agora foi para o eixo x! Fizemos isso com o **coord_flip()**

- Por último, colocamos o padrão de cores (**scale_fill_brewer(palette="Set2")**)  e alteramos a aparência geral (**theme_bw()**)


---
#Total de alunos por distrito


```r
# Grafico de quantidade de alunos por distrito
base_distritos &lt;- base_alunos %&gt;% 
  group_by(distrito) %&gt;% 
  summarise(contagem_alunos = n()) 

grafico_distritos &lt;- ggplot(base_distritos, 
                     aes(x= distrito, 
                     y= contagem_alunos, 
                    label = contagem_alunos)) +
  geom_bar(stat="identity", fill="#275C38") +
  geom_text(color= "white", size = 6, position = position_stack(vjust = 0.5)) +
  coord_flip() +
  theme_bw()

grafico_distritos
```


---
#Total de alunos por distrito

![](Aula_R_files/figure-html/unnamed-chunk-64-1.png)&lt;!-- --&gt;

---

# Expectativa de vida nos países

![](Aula_R_files/figure-html/unnamed-chunk-65-1.png)&lt;!-- --&gt;
---


# Expectativa de vida nos países


```r
base_paises &lt;- gapminder %&gt;% 
  filter(year==2007) %&gt;% 
  mutate(STP=case_when(
    country=="Sao Tome and Principe" ~ "STP", 
    TRUE~""))

graf_paises &lt;- base_paises %&gt;% 
  ggplot(aes(
    x=gdpPercap, 
    y=lifeExp, 
    color=continent, 
    size=pop)) +
  geom_point() +
  geom_text(aes(label=STP))+
  theme(legend.position = "None")

graf_paises
```

---

# Expectativa de vida nos países

![](Aula_R_files/figure-html/unnamed-chunk-67-1.png)&lt;!-- --&gt;

---


# Expectativa de vida nos países

- Alteramos o tamanho das bolas


```r
graf_paises2 &lt;- base_paises %&gt;% 
  ggplot(aes(
    x=gdpPercap, 
    y=lifeExp, 
    color=continent, 
    size=pop)) +
  geom_point(alpha=1/3) +
  geom_text(aes(label=STP, 
                size=30, 
                colour="black"))+
  theme(legend.position = "None") +
  scale_size_continuous(range=c(3,20))
  
graf_paises2
```

---

# Expectativa de vida nos países

![](Aula_R_files/figure-html/unnamed-chunk-69-1.png)&lt;!-- --&gt;

---

# Expectativa de vida nos países

- Adicionamos a escala logarítmica


```r
graf_paises3 &lt;- base_paises %&gt;% 
  ggplot(aes(
    x=gdpPercap, 
    y=lifeExp, 
    color=continent, 
    size=pop)) +
  geom_point(alpha=1/3) +
  geom_text(aes(label=STP, 
                size=30, 
                colour="black"))+
  theme(legend.position = "None") +
  scale_size_continuous(range=c(3,20)) +
  scale_x_log10()
  
graf_paises3
```

---

# Fazendo mapas com ggplot2 e sf

- Para fazer um mapa, preciosamos de um shapefile

- Precisamos também do pacote **sf**

- É fácil achar shapefiles de países, estados, províncias, municípios e distritos na internet

- Precisamos carregar a base de shapefile e fazer a ligação com a base de dados, que já precisa estar formatada corretamente

---

# Preparando a base para o mapa

- Utilizamos o comando **st_read()** para ler o shapefile 


```r
# Abre a base dos alunos
base_alunos&lt;- readRDS(paste0(tmp,"alunos_todos.RData"))

# Abre o shapefile
maps_STP &lt;- st_read(paste0(input,"shapes/stp_admbnda_adm2_gadm_2020.shp" ))
```


---
# Preparando a base para o mapa

- A base de dados precisa estar n mesmo nível das divisões do shapefile

- No caso, precisamos que ela esteja no nível do distrito

- Aqui, queremos calcular o número de alunos por turma. 

  - Primeiro agrupamos na turma, que na verdade é a combinação de escola, classe, turma, período, regime e área


```r
# Base escolar no nivel do distrito
base_distrito1 &lt;- base_alunos %&gt;%
  mutate(idade_5a  = ifelse(classe == 5, idade, NA),
         idade_8a  = ifelse(classe == 8, idade, NA),
         idade_11a = ifelse(classe ==11, idade, NA)) %&gt;% 
  group_by(distrito, nome_da_escola, classe, turma, 
           periodo, regime, 
           area_de_estudo_10a_a_12a_classe)
```

---
# Preparando a base para o mapa

- Agora calculamos o total de alunos na turma, e a média de idade dos alunos nas turmas de 5a, 8a e 11a classe


```r
base_distrito2 &lt;- base-distrito1 %&gt;% 
  summarise(alunos_turma=n(), 
            media_idade_5a_turma=mean(idade_5a,na.rm=TRUE), 
            media_idade_8a_turma=mean(idade_8a,na.rm=TRUE), 
            media_idade_11a_turma=mean(idade_11a,na.rm=TRUE))
```
            
---
# Preparando a base para o mapa

- Uma vez calculada a média de idade por turma e o total de alunos por cada turma, agrupamos por distrito para tirar as médias por distrito


```r
base_distrito3 &lt;- base_distrito2 %&gt;% 
  group_by(distrito) %&gt;% 
  summarise(total_alunos = n(), 
     media_alunos_turma  = mean(alunos_turma,na.rm = TRUE),
     media_idade_5a_dis  = weighted.mean(media_idade_5a_turma,alunos_turma,na.rm = TRUE ), 
            media_idade_8a_dis  = weighted.mean(media_idade_8a_turma,alunos_turma,na.rm = TRUE ), 
            media_idade_11a_dis = weighted.mean(media_idade_11a_turma,alunos_turma,na.rm = TRUE )) 
```

- Note que tiramos a média de idade dos alunos **PONDERADA** pelo tamanho das turmas. Por que?

  - Porque se tirássemos a média simples, as turmas pequenas entrariam com um peso desproporcional! Para que as turmas maiores tenham um peso maior, precisamos ponderar a média. 

---

# Preparando a base para o mapa

- Para fazer o join/"merge" horizontal, precisamos que as chaves das linhas sejam únicas. Caso contrário, as linhas não serão ligadas.



```r
base_distrito4 &lt;- base_distrito3 %&gt;%  
        mutate(ADM2_PCODE=
           case_when(distrito == "R.A.Príncipe" ~ "ST0101" , 
                     distrito == "Água Grande"  ~ "ST0201" ,
                     distrito == "Cantagalo"    ~ "ST0202" ,
                     distrito == "Caué"         ~ "ST0203" ,
                     distrito == "Lembá"        ~ "ST0204" ,
                     distrito == "Lobata"       ~ "ST0205" ,
                     distrito == "Mé-Zochi"     ~ "ST0206")) %&gt;% 
  left_join(maps_STP, by="ADM2_PCODE"))
```

- Finalmente, fazemos o **left_join**

- No último passo, precisamos aplicar a função **st_as_sf**


```r
base_distrito &lt;- st_as_sf(base_distrito4)
```

---

# Agora, o mapa!


```r
# Mapa!!!!
mapa_alunos &lt;- ggplot(base_distrito) +
  geom_sf(aes(fill=total_alunos), alpha=0.8, col="black") +
  scale_fill_viridis_c(option="magma", direction=-1) +
  labs( title = " Total de alunos por distrito") 

ggsave("mapa_alunos.png", plot=mapa_alunos)
```

---

# Mapa: Alunos por distrito



&lt;img src= "mapa_alunos.png", width=500&gt;

---

# Idade na 5a classe, por distrito


&lt;img src= "mapa_5a.png", width=500&gt;

---
# Trabalhando com Funções

- Para trabalhar com funções, iremos utilizar o pacote **purrr**, e a função **map**. Ele faz parte do **tidyverse** 

- Primeiro criamos a função



```r
tabela_distrito &lt;- function(x){
  
  y &lt;-base_alunos %&gt;% 
    filter(distrito==x)

print(x)  
  
crosstable(y, c(classe_f), by=c(distorcao), total="both", percent_pattern="{n} ({p_row})", percent_digits=0) %&gt;% as_flextable()
}
```

- Observe a função. Ela pega um elemento **x**, filtra a base por **x**, depois imprime **x**, e por último forma uma tabela 

---
# Trabalhando com Funções

- No segundo passo, precisamos apenas de um vetor, e mapear a função ao vetor. 

- O comando **map** funciona da seguinte forma:
  - **map(vetor, função)**

- Escrevemos então o vetor de distritos, e associamos a função à esse vetor


```r
vetor_distritos = c("Água Grande", "Cantagalo", "Caué", "Lembá",
                    "Lobata", "Mé-Zochi", "R.A.Príncipe")

map(vetor_distritos, tabela_distrito)
```

---

# O RMarkdown

- O RMarkdown nos permite fazer documentos e apresentações que tomam como resultado gráficos e tabelas produzidos pelo R

- O Markdown permite inserir pedaços de códigos no documento e rodá-los quando compilamos o código de markdown


---

# O cabeçalho do RMarkdown

- A parte mais importante do Markdown (YALM)

- O cabeçalho modifica o tipo de documento
  - Apresentação
  - Documento em HTML
  - Documento em pdf
  - Documento em word
  - Livro
  - Etc...

- É no cabeçalho que também inserimos os autores do documento, data e o estilo do documento

---

# Nosso cabeçalho

- Este é o cabeçalho deste documento


```r
---
title: "Manipulação de bases no R"
author: "Professor: Vitor Pereira"
date: '`r format(Sys.Date(), "%d/%m/%Y")`'
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
---
```
  
- Aqui estamos a utilizar a apresentação em **xaringan** ( é um pacote e precisa ser instalado), que é mais bonita do que a apresentação defaut do RMarkdown

---

# O primeiro chunk

- **chunk**s são os pedaços de código incluidos dentro do código de Markdown

  - Os **chunk**s estão sempre delimitados por 3 aspas simples
  
  - Deve se colocar as 3 aspas no início e final do chunk 
  
&lt;img src= "chunk1.png", width=600&gt;

- Aqui podemos mudar todo o estilo da nossa apresentação, incluindo as cores do slide

---

# Os chunks

- Na primeira linha do chunk, dizemos se queremos mostrar o código, mostrar o output e as mensagens de erro

Exemplos:

-  "**{r}**" : Executa, mostra o código e o output

-  "**{r,  eval=FALSE}**" Não executa, mas mostra o código

-  "**{r, results='hide', echo=FALSE}**" Executa, mas não mostra o código nem o output

-  "**{r, echo=FALSE, warning=FALSE, message=FALSE}**" Executa, mostra o output, mas não mostra mensagens

-  "**{r ,echo=FALSE, fig.width=10, fig.height=6}**" Executa, mostra o output e dá as dimensões do gráfico

  
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create();
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
